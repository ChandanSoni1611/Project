<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dyslexia Assessment Test - Smile Clinic</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            min-height: 100vh;
            padding: 20px;
        }

        nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 60px;
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            border-radius: 15px;
            margin-bottom: 30px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 24px;
            font-weight: 700;
            color: #1976d2;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: #1976d2;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
        }

        .back-btn {
            background: #1976d2;
            color: white;
            border: none;
            padding: 10px 28px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .back-btn:hover {
            background: #1565c0;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(25, 118, 210, 0.3);
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 40px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: #1976d2;
            font-size: 32px;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .page-loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(227, 242, 253, 0.95);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .page-loading.hidden {
            display: none;
        }

        .loading-content {
            text-align: center;
        }

        .loading-spinner {
            border: 6px solid #f3f3f3;
            border-top: 6px solid #1976d2;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        .user-info {
            background: #e3f2fd;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            border: 2px solid #bbdefb;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #1976d2;
            font-weight: 600;
            font-size: 16px;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #bbdefb;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
            background: white;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #1976d2;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .radio-group {
            display: flex;
            gap: 30px;
            margin-top: 10px;
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .radio-option input[type="radio"] {
            width: auto;
            cursor: pointer;
            transform: scale(1.3);
            accent-color: #1976d2;
        }

        .radio-option label {
            cursor: pointer;
            font-weight: 500;
            margin: 0;
            color: #333;
        }

        .submit-btn {
            background: #1976d2;
            color: white;
            border: none;
            padding: 14px 40px;
            border-radius: 30px;
            cursor: pointer;
            font-size: 18px;
            font-weight: 600;
            transition: all 0.3s;
            width: 100%;
            margin-top: 10px;
            box-shadow: 0 4px 15px rgba(25, 118, 210, 0.3);
        }

        .submit-btn:hover {
            background: #1565c0;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(25, 118, 210, 0.4);
        }

        .test-section {
            background: white;
            border: 2px solid #e3f2fd;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 25px;
            display: none;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            animation: fadeIn 0.5s ease-in;
        }

        .test-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .test-section h2 {
            color: #1976d2;
            font-size: 24px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 700;
            flex-wrap: wrap;
        }

        textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #bbdefb;
            border-radius: 8px;
            font-size: 16px;
            font-family: inherit;
            resize: vertical;
            min-height: 100px;
            transition: border-color 0.3s;
        }

        textarea:focus {
            outline: none;
            border-color: #1976d2;
        }

        .btn-primary {
            background: #1976d2;
            color: white;
            border: none;
            padding: 12px 35px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            margin-top: 15px;
            box-shadow: 0 4px 12px rgba(25, 118, 210, 0.3);
        }

        .btn-primary:hover {
            background: #1565c0;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(25, 118, 210, 0.4);
        }

        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .loading {
            text-align: center;
            padding: 20px;
            display: none;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #1976d2;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .language-badge {
            display: inline-block;
            padding: 6px 18px;
            background: #1976d2;
            color: white;
            border-radius: 20px;
            font-size: 14px;
            margin-left: 10px;
            font-weight: 600;
        }

        .warning-box {
            background: #fff3e0;
            border-left: 4px solid #ff9800;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
        }

        .warning-box h3 {
            color: #e65100;
            margin-bottom: 10px;
            font-size: 18px;
        }

        .warning-box p {
            color: #e65100;
            font-size: 15px;
            line-height: 1.6;
        }

        .error-message {
            background: #ffebee;
            border: 2px solid #e57373;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            margin-top: 20px;
            display: none;
        }

        .error-message.active {
            display: block;
        }

        .error-message h2 {
            color: #c62828;
            font-size: 28px;
            margin-bottom: 15px;
            font-weight: 700;
        }

        .error-message p {
            color: #c62828;
            font-size: 16px;
            line-height: 1.8;
            margin-bottom: 10px;
        }

        .error-icon {
            font-size: 60px;
            margin-bottom: 15px;
        }

        .complete-test-btn {
            background: #4caf50;
            color: white;
            border: none;
            padding: 16px 45px;
            border-radius: 30px;
            cursor: pointer;
            font-size: 18px;
            font-weight: 600;
            transition: all 0.3s;
            width: 100%;
            margin-top: 30px;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
        }

        .complete-test-btn:hover:not(:disabled) {
            background: #45a049;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
        }

        .complete-test-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .progress-bar {
            background: #e0e0e0;
            border-radius: 20px;
            height: 10px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress-fill {
            background: linear-gradient(90deg, #1976d2, #42a5f5);
            height: 100%;
            transition: width 0.5s ease;
            border-radius: 20px;
        }

        .test-header-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: #e3f2fd;
            border-radius: 10px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .test-number {
            font-size: 18px;
            font-weight: 700;
            color: #1976d2;
        }

        .end-test-btn {
            background: #f44336;
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .end-test-btn:hover {
            background: #d32f2f;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(244, 67, 54, 0.3);
        }

        .content-display {
            background: #f5f5f5;
            border: 2px solid #1976d2;
            border-radius: 10px;
            padding: 30px;
            margin: 20px 0;
            text-align: center;
            font-size: 24px;
            font-weight: 600;
            color: #333;
            line-height: 1.8;
            min-height: 150px;
            display: flex;
            align-items: center;
            justify-content: center;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .options-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .option-card {
            background: white;
            border: 3px solid #bbdefb;
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            font-size: 16px;
            font-weight: 600;
            color: #1976d2;
        }

        .option-card:hover {
            background: #e3f2fd;
            border-color: #1976d2;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(25, 118, 210, 0.2);
        }

        .option-card.selected {
            background: #1976d2;
            color: white;
            border-color: #1976d2;
        }

        .final-report {
            background: white;
            border: 3px solid #1976d2;
            border-radius: 15px;
            padding: 40px;
            margin-top: 30px;
            display: none;
            animation: fadeIn 0.5s ease-in;
        }

        .final-report.active {
            display: block;
        }

        .final-report h2 {
            color: #1976d2;
            font-size: 28px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 700;
        }

        .overall-result {
            text-align: center;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            font-size: 22px;
            font-weight: 700;
        }

        .overall-result.positive {
            background: #e8f5e9;
            border: 3px solid #4caf50;
            color: #2e7d32;
        }

        .overall-result.negative {
            background: #fff3e0;
            border: 3px solid #ff9800;
            color: #e65100;
        }

        .test-results-grid {
            display: grid;
            gap: 20px;
            margin-bottom: 30px;
        }

        .test-result-card {
            background: #f5f5f5;
            border-radius: 12px;
            padding: 25px;
            border-left: 5px solid #1976d2;
        }

        .test-result-card h3 {
            color: #1976d2;
            font-size: 20px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .test-result-card .status {
            display: inline-block;
            padding: 6px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            margin-left: auto;
        }

        .status.pass {
            background: #4caf50;
            color: white;
        }

        .status.concern {
            background: #ff9800;
            color: white;
        }

        .test-detail {
            margin: 10px 0;
            padding: 10px;
            background: white;
            border-radius: 8px;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .test-detail strong {
            color: #1976d2;
            display: inline-block;
            min-width: 150px;
        }

        .success-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .success-modal.active {
            display: flex;
        }

        .success-modal-content {
            background: white;
            border-radius: 20px;
            padding: 50px;
            text-align: center;
            max-width: 500px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .success-icon {
            font-size: 80px;
            margin-bottom: 20px;
            animation: bounce 0.6s ease-in-out;
        }

        @keyframes bounce {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        .success-modal h2 {
            color: #4caf50;
            font-size: 32px;
            margin-bottom: 15px;
            font-weight: 700;
        }

        .success-modal p {
            color: #666;
            font-size: 18px;
            line-height: 1.6;
            margin-bottom: 30px;
        }

        .btn-home {
            background: #4caf50;
            color: white;
            border: none;
            padding: 14px 35px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-home:hover {
            background: #45a049;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
        }

        .instruction-box {
            background: #e3f2fd;
            border: 2px solid #1976d2;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .instruction-box h4 {
            color: #1976d2;
            font-size: 18px;
            margin-bottom: 10px;
        }

        .instruction-box p {
            color: #333;
            font-size: 15px;
            line-height: 1.6;
        }

        .virtual-keyboard {
            background: #f5f5f5;
            border: 2px solid #1976d2;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            display: none;
        }

        .virtual-keyboard.active {
            display: block;
        }

        .keyboard-row {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 8px;
            flex-wrap: wrap;
        }

        .key {
            background: white;
            border: 2px solid #1976d2;
            border-radius: 8px;
            padding: 12px;
            min-width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            color: #1976d2;
            transition: all 0.2s;
            user-select: none;
        }

        .key:hover {
            background: #e3f2fd;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(25, 118, 210, 0.2);
        }

        .key:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(25, 118, 210, 0.2);
        }

        .key.space {
            min-width: 300px;
        }

        .key.backspace {
            min-width: 80px;
            background: #ff9800;
            border-color: #ff9800;
            color: white;
        }

        .key.backspace:hover {
            background: #f57c00;
        }

        .key.shift {
            min-width: 70px;
            background: #4caf50;
            border-color: #4caf50;
            color: white;
        }

        .key.shift:hover {
            background: #45a049;
        }

        .key.shift.active {
            background: #2e7d32;
        }

        .keyboard-toggle {
            text-align: center;
            margin-top: 10px;
        }

        .keyboard-toggle button {
            background: #1976d2;
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .keyboard-toggle button:hover {
            background: #1565c0;
        }

        .btn-record {
            background: #f44336;
            color: white;
            border: none;
            padding: 16px 40px;
            border-radius: 30px;
            cursor: pointer;
            font-size: 18px;
            font-weight: 600;
            transition: all 0.3s;
            margin-top: 20px;
            box-shadow: 0 4px 15px rgba(244, 67, 54, 0.3);
        }

        .btn-record:hover:not(:disabled) {
            background: #d32f2f;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(244, 67, 54, 0.4);
        }

        .btn-record:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-record.recording {
            background: #ff5722;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .recording-indicator {
            display: none;
            text-align: center;
            padding: 20px;
            background: #ffebee;
            border: 2px solid #f44336;
            border-radius: 10px;
            margin-top: 20px;
        }

        .recording-indicator.active {
            display: block;
        }

        .recording-indicator .pulse-dot {
            width: 20px;
            height: 20px;
            background: #f44336;
            border-radius: 50%;
            display: inline-block;
            margin-right: 10px;
            animation: pulse 1s infinite;
        }

        .recording-indicator p {
            color: #c62828;
            font-size: 16px;
            font-weight: 600;
            display: inline;
        }

        /* Mobile and Tablet Responsiveness */
        @media (max-width: 1024px) {
            .container {
                padding: 30px;
            }

            .content-display {
                font-size: 20px;
                padding: 25px;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            nav {
                padding: 15px 20px;
                flex-direction: column;
                gap: 15px;
            }

            .logo {
                font-size: 20px;
            }

            .logo-icon {
                width: 35px;
                height: 35px;
                font-size: 20px;
            }

            .container {
                padding: 20px;
            }

            .user-info {
                padding: 20px;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 24px;
            }

            .radio-group {
                flex-direction: column;
                gap: 15px;
            }

            .options-grid {
                grid-template-columns: 1fr;
            }

            .success-modal-content {
                padding: 30px 20px;
                margin: 20px;
            }

            .content-display {
                font-size: 18px;
                padding: 20px;
                min-height: 120px;
            }

            .test-section h2 {
                font-size: 20px;
            }

            .language-badge {
                margin-left: 0;
                margin-top: 5px;
            }

            .test-header-info {
                padding: 12px;
            }

            .test-number {
                font-size: 16px;
            }

            .key {
                min-width: 35px;
                height: 40px;
                padding: 8px;
                font-size: 14px;
            }

            .key.space {
                min-width: 180px;
            }

            .key.backspace, .key.shift {
                min-width: 60px;
            }

            .final-report {
                padding: 25px;
            }

            .final-report h2 {
                font-size: 24px;
            }

            .overall-result {
                padding: 20px;
                font-size: 18px;
            }

            .test-result-card {
                padding: 20px;
            }

            .test-result-card h3 {
                font-size: 18px;
            }

            .test-detail strong {
                min-width: 120px;
                display: block;
                margin-bottom: 5px;
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 20px;
            }

            .submit-btn, .complete-test-btn, .btn-record {
                padding: 12px 30px;
                font-size: 16px;
            }

            .content-display {
                font-size: 16px;
                padding: 15px;
            }

            .option-card {
                padding: 15px;
                font-size: 14px;
            }

            .key.space {
                min-width: 140px;
            }

            .warning-box, .instruction-box {
                padding: 15px;
            }

            .error-message {
                padding: 25px;
            }

            .error-message h2 {
                font-size: 22px;
            }

            .test-result-card .status {
                margin-left: 0;
                margin-top: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="page-loading" id="pageLoading">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <p style="color: #1976d2; font-size: 18px; font-weight: 600;">Loading Assessment Tool...</p>
        </div>
    </div>

    <nav id="mainNav" style="display: none;">
        <div class="logo">
            <div class="logo-icon">‚öïÔ∏è</div>
            <span>Smile Clinic</span>
        </div>
        <button class="back-btn" onclick="window.location.href='index.html'">‚Üê Back to Home</button>
    </nav>

    <div class="container" id="mainContainer" style="display: none;">
        <div class="header">
            <h1>Dyslexia Assessment Test</h1>
        </div>

        <div class="user-info" id="userInfoSection">
            <div class="warning-box">
                <h3>‚ö†Ô∏è Important Notice</h3>
                <p>This test requires normal vision, hearing, and speaking abilities. Please answer the following questions honestly before proceeding.</p>
            </div>

            <div class="form-group">
                <label style="font-size: 18px; color: #d32f2f;">Do you have any of the following problems?</label>
                <div style="margin-top: 15px; margin-bottom: 10px;">
                    <div style="padding: 10px; background: #fff; border-radius: 5px; margin-bottom: 8px;">
                        <strong>üëÅÔ∏è Eye Problem</strong> - Vision difficulties, cannot see clearly
                    </div>
                    <div style="padding: 10px; background: #fff; border-radius: 5px; margin-bottom: 8px;">
                        <strong>üëÇ Ear Problem</strong> - Hearing difficulties, cannot hear properly
                    </div>
                    <div style="padding: 10px; background: #fff; border-radius: 5px; margin-bottom: 8px;">
                        <strong>üó£Ô∏è Speaking Problem</strong> - Speech difficulties, trouble speaking
                    </div>
                </div>
                <div class="radio-group">
                    <div class="radio-option">
                        <input type="radio" id="problemYes" name="hasProblem" value="yes">
                        <label for="problemYes">Yes, I have one or more of these problems</label>
                    </div>
                    <div class="radio-option">
                        <input type="radio" id="problemNo" name="hasProblem" value="no">
                        <label for="problemNo">No, I don't have any of these problems</label>
                    </div>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="age">Age (5-10 years)</label>
                    <input type="number" id="age" min="5" max="10" placeholder="Enter age" required>
                </div>
                <div class="form-group">
                    <label for="language">Select Language</label>
                    <select id="language">
                        <option value="english" selected>English</option>
                        <option value="hindi">Hindi (‡§π‡§ø‡§Ç‡§¶‡•Ä)</option>
                        <option value="kannada">Kannada (‡≤ï‡≤®‡≥ç‡≤®‡≤°)</option>
                    </select>
                </div>
            </div>
           
            <button class="submit-btn" onclick="validateAndStartTest()">
                Submit & Start Test
            </button>
        </div>

        <div class="error-message" id="errorMessage">
            <div class="error-icon">üö´</div>
            <h2>Test Cannot Proceed</h2>
            <p>We're sorry, but this dyslexia assessment test cannot be conducted if you have eye, ear, or speaking problems.</p>
            <p><strong>Reason:</strong> The test requires normal vision to read text, normal hearing for audio instructions (if any), and normal speaking abilities for accurate assessment.</p>
            <p style="margin-top: 20px;">Please consult with a healthcare professional or specialist who can provide appropriate assessment methods suited to your specific needs.</p>
            <button class="back-btn" style="margin-top: 20px; display: inline-block;" onclick="window.location.href='index.html'">Return to Home</button>
        </div>

        <div id="testContainer" style="display: none;">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 0%"></div>
            </div>

            <div class="test-section" id="spellingSection">
                <div class="test-header-info">
                    <div class="test-number">Test 1 of 3: Spelling Test</div>
                    <button class="end-test-btn" onclick="endTest()">End Test</button>
                </div>

                <h2>
                    <span>‚úçÔ∏è</span> Spelling Test
                    <span class="language-badge" id="spellingLangBadge">English</span>
                </h2>

                <div class="instruction-box">
                    <h4>üìù Instructions:</h4>
                    <p>Please write a sentence in the text box below. Try to write naturally without worrying about spelling mistakes.</p>
                </div>
               
                <div class="form-group">
                    <label for="spellingInput">Write your sentence here:</label>
                    <textarea id="spellingInput" placeholder="Example: The quick brown fox jumps over the lazy dog"></textarea>
                </div>

                <div class="keyboard-toggle">
                    <button onclick="toggleKeyboard()" id="keyboardToggle">Show Virtual Keyboard</button>
                </div>

                <div class="virtual-keyboard" id="virtualKeyboard">
                    <div id="keyboardContent"></div>
                </div>

                <button class="btn-primary" onclick="testSpelling()" id="spellingBtn">
                    Submit & Continue to Next Test
                </button>

                <div class="loading" id="spellingLoading">
                    <div class="spinner"></div>
                    <p>Processing your response...</p>
                </div>
            </div>

            <div class="test-section" id="comprehensionSection">
                <div class="test-header-info">
                    <div class="test-number">Test 2 of 3: Reading Comprehension Test</div>
                    <button class="end-test-btn" onclick="endTest()">End Test</button>
                </div>

                <h2>
                    <span>üß†</span> Reading Comprehension Test
                    <span class="language-badge" id="comprehensionLangBadge">English</span>
                </h2>

                <div class="instruction-box">
                    <h4>üìñ Instructions:</h4>
                    <p>Read the content shown below carefully and select what it is related to from the options provided.</p>
                </div>

                <div class="content-display" id="contentDisplay"></div>

                <div class="form-group">
                    <label>What is this content related to?</label>
                    <div class="options-grid" id="optionsGrid"></div>
                </div>

                <button class="btn-primary" onclick="submitComprehension()" id="comprehensionBtn" disabled>
                    Submit & Continue to Speech Test
                </button>

                <div class="loading" id="comprehensionLoading">
                    <div class="spinner"></div>
                    <p>Processing your response...</p>
                </div>
            </div>

            <div class="test-section" id="speechSection">
                <div class="test-header-info">
                    <div class="test-number">Test 3 of 3: Speech Test</div>
                    <button class="end-test-btn" onclick="endTest()">End Test</button>
                </div>

                <h2>
                    <span>üé§</span> Speech Test
                    <span class="language-badge" id="speechLangBadge">English</span>
                </h2>

                <div class="instruction-box">
                    <h4>üéôÔ∏è Instructions:</h4>
                    <p>Read the content shown below aloud clearly into your microphone. Click "Start Recording" when you're ready to speak.</p>
                </div>

                <div class="content-display" id="speechContentDisplay"></div>

                <div style="text-align: center;">
                    <button class="btn-record" onclick="toggleRecording()" id="recordBtn">
                        üé§ Start Recording
                    </button>
                </div>

                <div class="recording-indicator" id="recordingIndicator">
                    <span class="pulse-dot"></span>
                    <p>Recording... Speak clearly into the microphone</p>
                </div>

                <div class="loading" id="speechLoading">
                    <div class="spinner"></div>
                    <p>Processing your speech...</p>
                </div>
            </div>

            <div class="final-report" id="finalReport">
                <h2>üìä Dyslexia Assessment Report</h2>
               
                <div class="overall-result" id="overallResult"></div>

                <div class="test-results-grid" id="testResultsGrid"></div>

                <div style="text-align: center; margin-top: 30px;">
                    <button class="complete-test-btn" onclick="saveAndComplete()" id="saveBtn">
                        Save Results & Complete
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="success-modal" id="successModal">
        <div class="success-modal-content">
            <div class="success-icon">‚úÖ</div>
            <h2>Test Completed!</h2>
            <p>Your results have been saved successfully. Thank you for completing the dyslexia assessment test.</p>
            <button class="btn-home" onclick="goToHome()">
                Return to Home
            </button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
        import { getDatabase, ref, push, set } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAjNK9sUByYR6cJvuqmiZWvsd47cMKV_lU",
            authDomain: "dyexdect.firebaseapp.com",
            databaseURL: "https://dyexdect-default-rtdb.firebaseio.com",
            projectId: "dyexdect",
            storageBucket: "dyexdect.firebasestorage.app",
            messagingSenderId: "749021614757",
            appId: "1:749021614757:web:8c3b027d88010bc4dd334c",
            measurementId: "G-5734WM4M2B"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);

        const comprehensionTests = {
            english: [
                {
                    content: "A journey of a thousand miles begins with a single step",
                    type: "idiom",
                    correctAnswer: "Motivation and Beginning",
                    options: ["Cooking Recipe", "Motivation and Beginning", "Weather Forecast", "Sports Rules"]
                },
                {
                    content: "The early bird catches the worm",
                    type: "phrase",
                    correctAnswer: "Time Management",
                    options: ["Animal Behavior", "Time Management", "Gardening Tips", "Mathematics"]
                }
            ],
            hindi: [
                {
                    content: "‡§Ö‡§Ç‡§ß‡•ã‡§Ç ‡§Æ‡•á‡§Ç ‡§ï‡§æ‡§®‡§æ ‡§∞‡§æ‡§ú‡§æ",
                    type: "idiom",
                    correctAnswer: "‡§∏‡§æ‡§Æ‡§æ‡§ú‡§ø‡§ï ‡§∏‡•ç‡§•‡§ø‡§§‡§ø",
                    options: ["‡§ñ‡§æ‡§®‡§æ ‡§™‡§ï‡§æ‡§®‡§æ", "‡§∏‡§æ‡§Æ‡§æ‡§ú‡§ø‡§ï ‡§∏‡•ç‡§•‡§ø‡§§‡§ø", "‡§Æ‡•å‡§∏‡§Æ", "‡§ñ‡•á‡§≤"]
                },
                {
                    content: "‡§¨‡•Ç‡§Ç‡§¶ ‡§¨‡•Ç‡§Ç‡§¶ ‡§∏‡•á ‡§∏‡§æ‡§ó‡§∞ ‡§≠‡§∞‡§§‡§æ ‡§π‡•à",
                    type: "phrase",
                    correctAnswer: "‡§ß‡•à‡§∞‡•ç‡§Ø ‡§î‡§∞ ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏",
                    options: ["‡§ú‡§æ‡§®‡§µ‡§∞", "‡§ß‡•à‡§∞‡•ç‡§Ø ‡§î‡§∞ ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏", "‡§¨‡§æ‡§ó‡§µ‡§æ‡§®‡•Ä", "‡§ó‡§£‡§ø‡§§"]
                }
            ],
            kannada: [
                {
                    content: "‡≤π‡≤®‡≤ø ‡≤π‡≤®‡≤ø ‡≤ï‡≥ä‡≤≤‡≥ç‡≤≤‡≤ø ‡≤Ü‡≤ó‡≥Å‡≤§‡≥ç‡≤§‡≤¶‡≥Ü",
                    type: "idiom",
                    correctAnswer: "‡≤§‡≤æ‡≤≥‡≥ç‡≤Æ‡≥Ü ‡≤Æ‡≤§‡≥ç‡≤§‡≥Å ‡≤™‡≥ç‡≤∞‡≤Ø‡≤§‡≥ç‡≤®",
                    options: ["‡≤Ö‡≤°‡≥Å‡≤ó‡≥Ü", "‡≤§‡≤æ‡≤≥‡≥ç‡≤Æ‡≥Ü ‡≤Æ‡≤§‡≥ç‡≤§‡≥Å ‡≤™‡≥ç‡≤∞‡≤Ø‡≤§‡≥ç‡≤®", "‡≤π‡≤µ‡≤æ‡≤Æ‡≤æ‡≤®", "‡≤ï‡≥ç‡≤∞‡≥Ä‡≤°‡≥Ü"]
                },
                {
                    content: "‡≤Æ‡≥ä‡≤¶‡≤≤ ‡≤π‡≥Ü‡≤ú‡≥ç‡≤ú‡≥Ü ‡≤Æ‡≥Å‡≤ñ‡≥ç‡≤Ø",
                    type: "phrase",
                    correctAnswer: "‡≤™‡≥ç‡≤∞‡≤æ‡≤∞‡≤Ç‡≤≠ ‡≤Æ‡≤§‡≥ç‡≤§‡≥Å ‡≤™‡≥ç‡≤∞‡≥á‡≤∞‡≤£‡≥Ü",
                    options: ["‡≤™‡≥ç‡≤∞‡≤æ‡≤£‡≤ø‡≤ó‡≤≥‡≥Å", "‡≤™‡≥ç‡≤∞‡≤æ‡≤∞‡≤Ç‡≤≠ ‡≤Æ‡≤§‡≥ç‡≤§‡≥Å ‡≤™‡≥ç‡≤∞‡≥á‡≤∞‡≤£‡≥Ü", "‡≤§‡≤∞‡≤ï‡≤æ‡≤∞‡≤ø", "‡≤ó‡≤£‡≤ø‡≤§"]
                }
            ]
        };

        const speechTests = {
            english: [
                {
                    content: "The quick brown fox jumps over the lazy dog",
                    type: "sentence"
                },
                {
                    content: "Actions speak louder than words",
                    type: "idiom"
                },
                {
                    content: "Every cloud has a silver lining",
                    type: "phrase"
                }
            ],
            hindi: [
                {
                    content: "‡§∏‡•Ç‡§∞‡§ú ‡§™‡•Ç‡§∞‡•ç‡§µ ‡§¶‡§ø‡§∂‡§æ ‡§∏‡•á ‡§â‡§ó‡§§‡§æ ‡§π‡•à",
                    type: "sentence"
                },
                {
                    content: "‡§ú‡•à‡§∏‡•Ä ‡§ï‡§∞‡§®‡•Ä ‡§µ‡•à‡§∏‡•Ä ‡§≠‡§∞‡§®‡•Ä",
                    type: "idiom"
                },
                {
                    content: "‡§è‡§ï‡§§‡§æ ‡§Æ‡•á‡§Ç ‡§¨‡§≤ ‡§π‡•à",
                    type: "phrase"
                }
            ],
            kannada: [
                {
                    content: "‡≤∏‡≥Ç‡≤∞‡≥ç‡≤Ø ‡≤™‡≥Ç‡≤∞‡≥ç‡≤µ‡≤¶‡≤ø‡≤Ç‡≤¶ ‡≤â‡≤¶‡≤Ø‡≤ø‡≤∏‡≥Å‡≤§‡≥ç‡≤§‡≤æ‡≤®‡≥Ü",
                    type: "sentence"
                },
                {
                    content: "‡≤π‡≤®‡≤ø ‡≤π‡≤®‡≤ø ‡≤ï‡≥ä‡≤≤‡≥ç‡≤≤‡≤ø",
                    type: "idiom"
                },
                {
                    content: "‡≤è‡≤ï‡≤§‡≥Ü‡≤Ø‡≤≤‡≥ç‡≤≤‡≤ø ‡≤∂‡≤ï‡≥ç‡≤§‡≤ø",
                    type: "phrase"
                }
            ]
        };

        const keyboardLayouts = {
            english: {
                numbers: ['1', '2', '3', '4', '5', '6', '7', '8', '9', '0'],
                row1: ['q', 'w', 'e', 'r', 't', 'y', 'u', 'i', 'o', 'p'],
                row2: ['a', 's', 'd', 'f', 'g', 'h', 'j', 'k', 'l'],
                row3: ['z', 'x', 'c', 'v', 'b', 'n', 'm']
            },
            hindi: {
                numbers: ['‡•ß', '‡•®', '‡•©', '‡•™', '‡•´', '‡•¨', '‡•≠', '‡•Æ', '‡•Ø', '‡•¶'],
                row1: ['‡§ï', '‡§ñ', '‡§ó', '‡§ò', '‡§ö', '‡§õ', '‡§ú', '‡§ù', '‡§û'],
                row2: ['‡§ü', '‡§†', '‡§°', '‡§¢', '‡§£', '‡§§', '‡§•', '‡§¶', '‡§ß', '‡§®'],
                row3: ['‡§™', '‡§´', '‡§¨', '‡§≠', '‡§Æ', '‡§Ø', '‡§∞', '‡§≤', '‡§µ'],
                row4: ['‡§∂', '‡§∑', '‡§∏', '‡§π', '‡§ï‡•ç‡§∑', '‡§§‡•ç‡§∞', '‡§ú‡•ç‡§û'],
                vowels: ['‡§Ö', '‡§Ü', '‡§á', '‡§à', '‡§â', '‡§ä', '‡§è', '‡§ê', '‡§ì', '‡§î']
            },
            kannada: {
                numbers: ['‡≥ß', '‡≥®', '‡≥©', '‡≥™', '‡≥´', '‡≥¨', '‡≥≠', '‡≥Æ', '‡≥Ø', '‡≥¶'],
                row1: ['‡≤ï', '‡≤ñ', '‡≤ó', '‡≤ò', '‡≤ô', '‡≤ö', '‡≤õ', '‡≤ú', '‡≤ù', '‡≤û'],
                row2: ['‡≤ü', '‡≤†', '‡≤°', '‡≤¢', '‡≤£', '‡≤§', '‡≤•', '‡≤¶', '‡≤ß', '‡≤®'],
                row3: ['‡≤™', '‡≤´', '‡≤¨', '‡≤≠', '‡≤Æ', '‡≤Ø', '‡≤∞', '‡≤≤', '‡≤µ'],
                row4: ['‡≤∂', '‡≤∑', '‡≤∏', '‡≤π', '‡≤≥', '‡≥û'],
                vowels: ['‡≤Ö', '‡≤Ü', '‡≤á', '‡≤à', '‡≤â', '‡≤ä', '‡≤é', '‡≤è', '‡≤ê', '‡≤í', '‡≤ì', '‡≤î']
            }
        };

        let currentUser = null;
        let testStarted = false;
        let currentTestIndex = 0;
        let selectedOption = null;
        let currentComprehensionTest = null;
        let currentSpeechTest = null;
        let isShiftActive = false;
        let currentKeyboardLanguage = 'english';
        let mediaRecorder = null;
        let audioChunks = [];
        let isRecording = false;
        let testData = {
            spellingTest: null,
            comprehensionTest: null,
            speechTest: null,
            age: null,
            language: null
        };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
            } else {
                alert('Please login to take the test');
                window.location.href = 'index.html';
            }
        });

        window.addEventListener('DOMContentLoaded', function() {
            setTimeout(function() {
                document.getElementById('pageLoading').classList.add('hidden');
                document.getElementById('mainNav').style.display = 'flex';
                document.getElementById('mainContainer').style.display = 'block';
            }, 500);
        });

        document.getElementById('language').addEventListener('change', function() {
            const displayName = this.options[this.selectedIndex].text;
            const selectedLang = this.value;
            document.getElementById('spellingLangBadge').textContent = displayName;
            document.getElementById('comprehensionLangBadge').textContent = displayName;
            document.getElementById('speechLangBadge').textContent = displayName;
            currentKeyboardLanguage = selectedLang;
            if (document.getElementById('virtualKeyboard').classList.contains('active')) {
                renderKeyboard();
            }
        });

        function updateProgress() {
            const progress = (currentTestIndex / 3) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
        }

        window.endTest = function() {
            if (confirm('Are you sure you want to end the test? Your progress will not be saved.')) {
                window.location.href = 'index.html';
            }
        }

        function renderKeyboard() {
            const layout = keyboardLayouts[currentKeyboardLanguage];
            const keyboardContent = document.getElementById('keyboardContent');
           
            let html = '';
           
            html += '<div class="keyboard-row">';
            layout.numbers.forEach(num => {
                html += `<div class="key" onclick="addChar('${num}')">${num}</div>`;
            });
            html += '</div>';
           
            if (layout.vowels) {
                html += '<div class="keyboard-row">';
                layout.vowels.forEach(vowel => {
                    html += `<div class="key" onclick="addChar('${vowel}')">${vowel}</div>`;
                });
                html += '</div>';
            }
           
            html += '<div class="keyboard-row">';
            layout.row1.forEach(char => {
                html += `<div class="key" onclick="addChar('${char}')">${char.toUpperCase()}</div>`;
            });
            html += '</div>';
           
            html += '<div class="keyboard-row">';
            layout.row2.forEach(char => {
                html += `<div class="key" onclick="addChar('${char}')">${char.toUpperCase()}</div>`;
            });
            html += '</div>';
           
            html += '<div class="keyboard-row">';
            if (currentKeyboardLanguage === 'english') {
                html += '<div class="key shift" onclick="toggleShift()" id="shiftKey">‚áß Shift</div>';
            }
            layout.row3.forEach(char => {
                html += `<div class="key" onclick="addChar('${char}')">${char.toUpperCase()}</div>`;
            });
            html += '<div class="key backspace" onclick="backspace()">‚å´ Back</div>';
            html += '</div>';
           
            if (layout.row4) {
                html += '<div class="keyboard-row">';
                layout.row4.forEach(char => {
                    html += `<div class="key" onclick="addChar('${char}')">${char}</div>`;
                });
                html += '</div>';
            }
           
            html += '<div class="keyboard-row">';
            html += '<div class="key" onclick="addChar(\',\')">,</div>';
            html += '<div class="key space" onclick="addChar(\' \')">Space</div>';
            html += '<div class="key" onclick="addChar(\'.\')">.</div>';
            html += '</div>';
           
            keyboardContent.innerHTML = html;
        }

        window.toggleKeyboard = function() {
            const keyboard = document.getElementById('virtualKeyboard');
            const toggleBtn = document.getElementById('keyboardToggle');
           
            if (keyboard.classList.contains('active')) {
                keyboard.classList.remove('active');
                toggleBtn.textContent = 'Show Virtual Keyboard';
            } else {
                keyboard.classList.add('active');
                toggleBtn.textContent = 'Hide Virtual Keyboard';
                renderKeyboard();
            }
        }

        window.addChar = function(char) {
            const textarea = document.getElementById('spellingInput');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const text = textarea.value;
           
            let charToAdd = char;
           
            if (currentKeyboardLanguage === 'english' && isShiftActive && char.length === 1 && /[a-z]/.test(char)) {
                charToAdd = char.toUpperCase();
                isShiftActive = false;
                const shiftKey = document.getElementById('shiftKey');
                if (shiftKey) {
                    shiftKey.classList.remove('active');
                }
            }
           
            textarea.value = text.substring(0, start) + charToAdd + text.substring(end);
            textarea.selectionStart = textarea.selectionEnd = start + charToAdd.length;
            textarea.focus();
        }

        window.backspace = function() {
            const textarea = document.getElementById('spellingInput');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const text = textarea.value;
           
            if (start !== end) {
                textarea.value = text.substring(0, start) + text.substring(end);
                textarea.selectionStart = textarea.selectionEnd = start;
            } else if (start > 0) {
                textarea.value = text.substring(0, start - 1) + text.substring(start);
                textarea.selectionStart = textarea.selectionEnd = start - 1;
            }
            textarea.focus();
        }

        window.toggleShift = function() {
            if (currentKeyboardLanguage !== 'english') return;
           
            isShiftActive = !isShiftActive;
            const shiftKey = document.getElementById('shiftKey');
           
            if (shiftKey) {
                if (isShiftActive) {
                    shiftKey.classList.add('active');
                } else {
                    shiftKey.classList.remove('active');
                }
            }
        }

        window.validateAndStartTest = function() {
            const problemRadio = document.querySelector('input[name="hasProblem"]:checked');
            if (!problemRadio) {
                alert('Please select whether you have any eye, ear, or speaking problems');
                return;
            }

            if (problemRadio.value === 'yes') {
                document.getElementById('userInfoSection').style.display = 'none';
                document.getElementById('errorMessage').classList.add('active');
                document.getElementById('testContainer').style.display = 'none';
                return;
            }

            const age = parseInt(document.getElementById('age').value);
            if (!age || age < 5 || age > 10) {
                alert('Please enter a valid age between 5 and 10 years');
                return;
            }

            testData.age = age;
            testData.language = document.getElementById('language').value;
            currentKeyboardLanguage = testData.language;

            document.getElementById('userInfoSection').style.display = 'none';
            document.getElementById('errorMessage').classList.remove('active');
            document.getElementById('testContainer').style.display = 'block';
            document.getElementById('spellingSection').classList.add('active');
            testStarted = true;
            updateProgress();
        }

        window.testSpelling = async function() {
            if (!testStarted) {
                alert('Please complete the initial form first');
                return;
            }

            const text = document.getElementById('spellingInput').value.trim();
            const language = document.getElementById('language').value;

            if (!text) {
                alert('Please write a sentence to continue');
                return;
            }

            const btn = document.getElementById('spellingBtn');
            const loading = document.getElementById('spellingLoading');

            btn.disabled = true;
            loading.style.display = 'block';

            try {
                const response = await fetch('http://localhost:5000/correct_spelling', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        text: text,
                        language: language
                    })
                });

                const data = await response.json();

                if (data.error) {
                    alert('Error: ' + data.error);
                    btn.disabled = false;
                } else {
                    // FIXED: Limit corrected text length to prevent display issues
                    let correctedText = data.corrected;
                    const MAX_LENGTH = 500; // Maximum characters to display
                   
                    if (correctedText.length > MAX_LENGTH) {
                        correctedText = correctedText.substring(0, MAX_LENGTH) + '... (text truncated)';
                    }

                    testData.spellingTest = {
                        original: data.original,
                        corrected: correctedText,
                        language: data.language,
                        hasErrors: data.original.toLowerCase() !== data.corrected.toLowerCase()
                    };

                    currentTestIndex = 1;
                    updateProgress();
                   
                    setTimeout(() => {
                        document.getElementById('spellingSection').classList.remove('active');
                        loadComprehensionTest();
                    }, 500);
                }
            } catch (error) {
                alert('Error: ' + error.message + '\nMake sure the Flask server is running on http://localhost:5000');
                btn.disabled = false;
            } finally {
                loading.style.display = 'none';
            }
        }

        function loadComprehensionTest() {
            const language = testData.language;
            const tests = comprehensionTests[language];
           
            currentComprehensionTest = tests[Math.floor(Math.random() * tests.length)];
           
            document.getElementById('contentDisplay').textContent = currentComprehensionTest.content;
           
            const optionsGrid = document.getElementById('optionsGrid');
            optionsGrid.innerHTML = '';
           
            currentComprehensionTest.options.forEach((option, index) => {
                const optionCard = document.createElement('div');
                optionCard.className = 'option-card';
                optionCard.textContent = option;
                optionCard.onclick = () => selectOption(option, optionCard);
                optionsGrid.appendChild(optionCard);
            });
           
            document.getElementById('comprehensionSection').classList.add('active');
        }

        function selectOption(option, element) {
            document.querySelectorAll('.option-card').forEach(card => {
                card.classList.remove('selected');
            });
           
            element.classList.add('selected');
            selectedOption = option;
           
            document.getElementById('comprehensionBtn').disabled = false;
        }

        window.submitComprehension = function() {
            if (!selectedOption) {
                alert('Please select an option');
                return;
            }

            const isCorrect = selectedOption === currentComprehensionTest.correctAnswer;
           
            testData.comprehensionTest = {
                content: currentComprehensionTest.content,
                type: currentComprehensionTest.type,
                selectedAnswer: selectedOption,
                correctAnswer: currentComprehensionTest.correctAnswer,
                isCorrect: isCorrect,
                language: testData.language
            };

            currentTestIndex = 2;
            updateProgress();
           
            setTimeout(() => {
                document.getElementById('comprehensionSection').classList.remove('active');
                loadSpeechTest();
            }, 500);
        }

        function loadSpeechTest() {
            const language = testData.language;
            const tests = speechTests[language];
           
            currentSpeechTest = tests[Math.floor(Math.random() * tests.length)];
           
            document.getElementById('speechContentDisplay').textContent = currentSpeechTest.content;
           
            document.getElementById('speechSection').classList.add('active');
        }

        window.toggleRecording = async function() {
            if (isRecording) {
                stopRecording();
            } else {
                await startRecording();
            }
        }

        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];

                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    await processSpeech(audioBlob);
                   
                    stream.getTracks().forEach(track => track.stop());
                };

                mediaRecorder.start();
                isRecording = true;

                document.getElementById('recordBtn').textContent = '‚èπÔ∏è Stop Recording';
                document.getElementById('recordBtn').classList.add('recording');
                document.getElementById('recordingIndicator').classList.add('active');

            } catch (error) {
                alert('Error accessing microphone: ' + error.message);
                console.error('Microphone error:', error);
            }
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
                isRecording = false;

                document.getElementById('recordBtn').textContent = 'üé§ Start Recording';
                document.getElementById('recordBtn').classList.remove('recording');
                document.getElementById('recordingIndicator').classList.remove('active');
                document.getElementById('recordBtn').disabled = true;
            }
        }

        async function processSpeech(audioBlob) {
            const loading = document.getElementById('speechLoading');
            loading.style.display = 'block';

            try {
                const formData = new FormData();
                formData.append('audio', audioBlob, 'recording.wav');
                formData.append('expected_text', currentSpeechTest.content);
                formData.append('language', testData.language);

                const response = await fetch('http://localhost:5000/speech_test', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.error) {
                    alert('Error: ' + data.error);
                    document.getElementById('recordBtn').disabled = false;
                } else {
                    testData.speechTest = {
                        expectedText: data.expected_text,
                        transcribedText: data.transcribed_text,
                        similarity: data.similarity,
                        isPassed: data.is_passed,
                        type: currentSpeechTest.type,
                        language: data.language
                    };

                    currentTestIndex = 3;
                    updateProgress();
                   
                    setTimeout(() => {
                        document.getElementById('speechSection').classList.remove('active');
                        showFinalReport();
                    }, 500);
                }
            } catch (error) {
                alert('Error: ' + error.message + '\nMake sure the Flask server is running on http://localhost:5000');
                document.getElementById('recordBtn').disabled = false;
            } finally {
                loading.style.display = 'none';
            }
        }

        function showFinalReport() {
            const spellingTest = testData.spellingTest;
            const comprehensionTest = testData.comprehensionTest;
            const speechTest = testData.speechTest;

            let failedTests = 0;
            if (spellingTest.hasErrors) failedTests++;
            if (!comprehensionTest.isCorrect) failedTests++;
            if (!speechTest.isPassed) failedTests++;

            const hasDyslexia = failedTests >= 2;

            const overallResultDiv = document.getElementById('overallResult');
            if (hasDyslexia) {
                overallResultDiv.className = 'overall-result negative';
                overallResultDiv.innerHTML = `
                    <div style="font-size: 50px; margin-bottom: 15px;">‚ö†Ô∏è</div>
                    <div>Assessment Result: Indicators of Dyslexia Detected</div>
                    <div style="font-size: 16px; margin-top: 10px; font-weight: 500;">
                        The user showed difficulties in ${failedTests} out of 3 tests.
                    </div>
                    <div style="font-size: 14px; margin-top: 15px; font-weight: 400; color: #666;">
                        Recommendation: Please consult with a healthcare professional for further evaluation.
                    </div>
                `;
            } else {
                overallResultDiv.className = 'overall-result positive';
                overallResultDiv.innerHTML = `
                    <div style="font-size: 50px; margin-bottom: 15px;">‚úÖ</div>
                    <div>Assessment Result: No Significant Indicators Detected</div>
                    <div style="font-size: 16px; margin-top: 10px; font-weight: 500;">
                        The user performed well in the tests (failed ${failedTests} out of 3).
                    </div>
                `;
            }

            const testResultsGrid = document.getElementById('testResultsGrid');
            testResultsGrid.innerHTML = `
                <div class="test-result-card">
                    <h3>
                        <span>‚úçÔ∏è</span> Spelling Test
                        <span class="status ${spellingTest.hasErrors ? 'concern' : 'pass'}">
                            ${spellingTest.hasErrors ? 'Concerns Detected' : 'Passed'}
                        </span>
                    </h3>
                    <div class="test-detail">
                        <strong>Original Text:</strong> ${spellingTest.original}
                    </div>
                    <div class="test-detail">
                        <strong>Corrected Text:</strong> ${spellingTest.corrected}
                    </div>
                    <div class="test-detail">
                        <strong>Language:</strong> ${spellingTest.language.charAt(0).toUpperCase() + spellingTest.language.slice(1)}
                    </div>
                    <div class="test-detail">
                        <strong>Result:</strong> ${spellingTest.hasErrors ?
                            'Spelling errors detected - May indicate reading/writing difficulties' :
                            'No significant spelling errors detected'}
                    </div>
                </div>

                <div class="test-result-card">
                    <h3>
                        <span>üß†</span> Reading Comprehension Test
                        <span class="status ${!comprehensionTest.isCorrect ? 'concern' : 'pass'}">
                            ${!comprehensionTest.isCorrect ? 'Concerns Detected' : 'Passed'}
                        </span>
                    </h3>
                    <div class="test-detail">
                        <strong>Content Type:</strong> ${comprehensionTest.type.charAt(0).toUpperCase() + comprehensionTest.type.slice(1)}
                    </div>
                    <div class="test-detail">
                        <strong>Content:</strong> ${comprehensionTest.content}
                    </div>
                    <div class="test-detail">
                        <strong>Your Answer:</strong> ${comprehensionTest.selectedAnswer}
                    </div>
                    <div class="test-detail">
                        <strong>Correct Answer:</strong> ${comprehensionTest.correctAnswer}
                    </div>
                    <div class="test-detail">
                        <strong>Language:</strong> ${comprehensionTest.language.charAt(0).toUpperCase() + comprehensionTest.language.slice(1)}
                    </div>
                    <div class="test-detail">
                        <strong>Result:</strong> ${!comprehensionTest.isCorrect ?
                            'Incorrect answer - May indicate comprehension difficulties' :
                            'Correct answer - Good comprehension skills'}
                    </div>
                </div>

                <div class="test-result-card">
                    <h3>
                        <span>üé§</span> Speech Test
                        <span class="status ${!speechTest.isPassed ? 'concern' : 'pass'}">
                            ${!speechTest.isPassed ? 'Concerns Detected' : 'Passed'}
                        </span>
                    </h3>
                    <div class="test-detail">
                        <strong>Content Type:</strong> ${speechTest.type.charAt(0).toUpperCase() + speechTest.type.slice(1)}
                    </div>
                    <div class="test-detail">
                        <strong>Expected Text:</strong> ${speechTest.expectedText}
                    </div>
                    <div class="test-detail">
                        <strong>Your Speech:</strong> ${speechTest.transcribedText}
                    </div>
                    <div class="test-detail">
                        <strong>Similarity Score:</strong> ${(speechTest.similarity * 100).toFixed(2)}%
                    </div>
                    <div class="test-detail">
                        <strong>Language:</strong> ${speechTest.language.charAt(0).toUpperCase() + speechTest.language.slice(1)}
                    </div>
                    <div class="test-detail">
                        <strong>Result:</strong> ${!speechTest.isPassed ?
                            'Low similarity - May indicate speech/pronunciation difficulties' :
                            'Good pronunciation and clarity'}
                    </div>
                </div>
            `;

            document.getElementById('finalReport').classList.add('active');
        }

        window.saveAndComplete = async function() {
            if (!testData.spellingTest || !testData.comprehensionTest || !testData.speechTest) {
                alert('Please complete all tests before submitting');
                return;
            }

            if (!currentUser) {
                alert('User not authenticated. Please login again.');
                window.location.href = 'index.html';
                return;
            }

            const btn = document.getElementById('saveBtn');
            btn.disabled = true;
            btn.textContent = 'Saving Results...';

            try {
                const testResultsRef = ref(database, 'test_results');
                const newTestRef = push(testResultsRef);

                const spellingTest = testData.spellingTest;
                const comprehensionTest = testData.comprehensionTest;
                const speechTest = testData.speechTest;
               
                let failedTests = 0;
                if (spellingTest.hasErrors) failedTests++;
                if (!comprehensionTest.isCorrect) failedTests++;
                if (!speechTest.isPassed) failedTests++;
                const hasDyslexia = failedTests >= 2;
               
                const resultData = {
                    userId: currentUser.uid,
                    userEmail: currentUser.email,
                    age: testData.age,
                    language: testData.language,
                    spellingTest: testData.spellingTest,
                    comprehensionTest: testData.comprehensionTest,
                    speechTest: testData.speechTest,
                    overallResult: {
                        hasDyslexia: hasDyslexia,
                        failedTests: failedTests,
                        totalTests: 3
                    },
                    timestamp: Date.now()
                };

                await set(newTestRef, resultData);

                document.getElementById('successModal').classList.add('active');
            } catch (error) {
                console.error('Error saving test results:', error);
                alert('‚ùå Error saving test results: ' + error.message);
                btn.disabled = false;
                btn.textContent = 'Save Results & Complete';
            }
        }

        window.goToHome = function() {
            window.location.href = 'index.html';
        }
    </script>
</body>
</html>
